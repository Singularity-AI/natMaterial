<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
 
<style type="text/css">
body
{
    margin-left:  30px;
    margin-right: 30px;
};

P
{
    font-family: Tahoma;
    font-size: 10pt;
};

a, a:visited, a:active, a:link, a:hover {
    text-decoration: underline;
    color: #545454;
    background-color: transparent;
}

a:hover {
    background-color: #cccccc;
}


hr {
    clear: both;
    height: 1px;
    color: #242424;
    background-color: transparent;
}

h1, h2, h3 {
    color: #242424;
    clear: left;
    font: 100% Tahoma, Helvetica, Arial, sans-serif;
    margin-bottom: 0.5em;
    padding-top: 0.5em;
	border-radius: 10px;
	padding: 5px;
}

top {
	width: 100%;
}


#i {
    color: #ff1010;
}
tt{
	font-family: "Arial";
    font-size: 80%;
	color: #006600;
}
em{
	font-family: "Arial";
    font-size: 80%;
	font-weight: bold;
	border-style:solid;
	border-color: #abe876;
    color: #1632cc;
}
bc{
	font-family: "Arial";
	font-size: 80%;
	font-weight: bold;
    color: #990000;
	background-color: #fcf8c7;
}
ks{
	font-family: "Arial";
	font-weight: bold;
    color: #0000CD	;
	 
}
kc{
	font-family: "Arial";
	font-weight: bold;
    color: #008000	;
	 
}
pre{
	font-family: "Consolas";
	font-size: 85%;
	background-color: #f5f5f5;
	border: 1.5px solid silver;
	padding: 5px;
}
m{
	font-family: "Helvetica";
	line-height: 100%;
 	font-size: 75%;
}
div.body{
	width: 700px;
    font-size: 15px;
}
k{
    color: #990000;
	font-weight: bold;
}
h1 {
    font-size: 150%;
    background-color: #b2c0ff;
	padding: 10px; 
}

h2 {
    background-color: #9ed8ff;
    font-size: 130%;
}

h3 {
	background-color: #e6ccff;
    font-size: 100%;
}
h4 {
    background-color: #C0F0E0;
    font-size: 100%;
	width: 95%;
	border-radius: 5px;
	padding: 2px;
}
h5 {
    background-color: #d5ffb0;
    font-size: 100%;
	
}    
div.req{
	background-color: #d9ffb3;
    font-size: 18px;
	width: 700px;
    border: 3px solid green;
    padding: 15px;
    margin: 10px;
}       
div.remark{
	background-color: #E3F2FD;	
    border: 1.5px solid #d5f2ed;
    padding: 15px;
    margin: 10px;
	border-radius: 25px;
}  
table, th, td {
  border: 1px solid black;
  border-collapse: collapse;
} 

ol, ul, li {
  margin: 0;
  margin-left: 10px;
  padding: 0;
  padding-bottom: 5px;
}     

table, th, td {
	border: 1px solid black;
}

img {
	border: 1.5px solid #d5f2ed
	
}

a, a:visited, a:active, a:link, a:hover {
    text-decoration: underline;
    color: #545454;
    background-color: transparent;
}

div.wrapdesc{
	width: 90%;
	margin: auto;
}

div.imagedesc{
	width: 85%;
	margin: auto;
}
</style>
    
<head>
   
<title>DISIHlLFhirConversion</title></head>
    
<body>
<div id="body">
<h1>DISI HealthAdapter | HL7 to Fhir Conversion</h1>

<h2>References</h2>
<m> 
<ul>
<li><a href="https://dev-itel.atlassian.net/wiki/spaces/NEXTAGORA/overview" target="web">Confluence space: Nextagora</a>&nbsp;&nbsp;&nbsp;
 <a href="https://dev-itel.atlassian.net/wiki/spaces/UNIBO/overview" target="web">Confluence space: UNIBO</a>&nbsp;&nbsp;&nbsp;
 <a href="https://bitbucket.org/itelunibo/workspace/projects/" target="web">Projects on bitbucket</a> </li>
<!--
<li><a href="https://bitbucket.org/itelunibo/overviewrepo/src/master/it.unibo.itel/userDocs/3-LogicalArch/HDA_Disi.html" target="web">HDA_Disi.html (overviewrepo)</a> </li>
-->
<hr/>
<li><a href="HapiUsage.html" target="web"> DISI - HapiUsage.html</a> &nbsp;&nbsp;&nbsp;
 <a href="https://hapifhir.io/hapi-fhir/apidocs/hapi-fhir-base/index-all.html" target="web">FHIR Api docs</a>&nbsp;&nbsp;&nbsp;
 <a href="https://hapifhir.io/hapi-fhir/apidocs/hapi-fhir-structures-r4/index-all.html" target="web">FHIR Api structures docs</a>&nbsp;&nbsp;&nbsp;
 <a href="https://www.hl7.org/fhir/R4/patient.html" target="web">FHIR 8.1 Resource Patient - Content</a>
</li>
</ul></m>

 <!--
<pre>
https://derickbailey.com/2017/03/09/selecting-a-node-js-image-for-docker/
docker pull node:10-alpine
docker run -it --rm node:10-alpine node --version	=> 10.22	(load se non esiste) - 108MB
docker run -it --rm 5ebbf4bb3837 --version			=> 10.22     node caricato da fhirconverter - 911MB
docker run -it --rm 23852efb7270 --version			mhart/alpine-node MA OCI runtime create failed
docker exec -it fhircvt bash
</pre>
-->
<h2>Introduzione</h2>
Quest progetto (<tt>natmaterial/DISIFhirHl7Converter</tt>) isola la parte di trasformazione del progetto 
<a href="https://github.com/microsoft/FHIR-Converter" target="web">Microsoft FHIR-Converter</a>
basato su Node.js.
<br/><br/>
L'intento e' fornire un servizio <tt>REST</tt> alla porta <ks>3000</ks> con API POST <ks>/hl7tofhir</ks> che accetta due parametri:

<ol>
<li><i>templateb64</i>: Una stringa codificata <em>base64</em> che rappresenta il template <k>hbs</k> di riferimento per la trasformazione</li>
<li><i>hl7b64</i>:Una stringa codificata <em>base64</em> che rappresenta il messaggio HL7 da trasformare</li>
</ol>

<h3>Build the Docker Image (<a href="../Dockerfile" target="code">Dockerfile</a>, <a href="../package.json" target="code">package.json</a>)</h3>
<pre>
In <kc>natmaterial/DISIFhirHl7Converter</kc>:
docker build --tag disifhircvtimage . 		<kc>//101 MB</kc>
docker run --name disifhircvt  --rm  -p3000:3000  disifhircvtimage
docker exec -it disifhircvt bash 		<kc>//Per vedere l'interno</kc>
</pre>

<h3>Il server</h3>
Il srvizio e' realizzato utilizzando Express e si articola in:



<ol>
<li><a href="../app.js" target="code">app.js</a>: delega la API <ks>/hl7tofhir</ks> a <a href="../routes/disicvt.js" target="code">routes/disicvt.js</a>  </li>
<li><a href="../routes/disicvt.js" target="code">routes/disicvt.js</a>:  trasforma in String gli argomenti codificati <tt>base64</tt> e
chiama la operazione <m><ks>convert(templateString, HL7Msg, response) </ks></m> di
<a href="../DisiFhirConverter/workers/uniboworker.js" target="code">uniboworker.js</a> cosi' definita:
<pre>
function <ks>convert( templateString, HL7Msg, <k>response</k> )</ks> {
	workData.srcDataType	= "hl7v2";
	workData.templateString = templateString;	<i>templateString letta da file</i>
	workData.msg            = HL7Msg;		<i>dato HL7 letto da file</i>
	<ks>doconvert(workData, <k>response</k> );</ks>
</pre>
<li>la operazione <m><ks>doconvert(workData, response) </ks></m> innseca il processo di trasformazione definito da Microsoft descritto piu' avanti.
</li> 
</ol>

<h3>La esecuzione</h3>
<h4>Offline <!-- (WARNING: solo con node 6.10) --></h4>
Una esecuzione 'offline' (puo' essere effettuata invocando:
<pre>
In <kc>\DISIFhirHl7Converter/DisiFhirConverter/workers</kc>
node rununiboworker.js
</pre>
Questo 'main' invoca la funzione <ks>convert</ks> di <a href="../DisiFhirConverter/workers/uniboworker.js" target="code">uniboworker.js</a>
che e' la stessa funzione invocata da <a href="../routes/disicvt.js" target="code">routes/disicvt.js</a> nella versione 'online'.
<br/>
<!-- Con node <ks>v12.18.0</ks> purtroppo si ha l'errore <tt>Cannot find module 'uuid'</tt>: -->

<h4>Online</h4>
Prima si attiva il servizio usando docker
<pre>
docker rm -f disifhircvt			<kc>//remove previous activations (if needed)</kc>
docker build --tag disifhircvtimage .		<kc>//rebuild the image (if needed)</kc>
docker run --name disifhircvt  --rm  -p3000:3000  disifhircvtimage	<kc>//activate the service on port 3000</kc>
</pre>

Successivamente, si puo' eseguire un client scritto in Java:
<pre>
In <kc>HealthAdapterFacade/src/main/java/it/unibo/HealthAdapter/Clients</kc>
run <a href="../../HealthAdapterFacade/src/main/java/it/unibo/HealthAdapter/Clients/DisicvtClient.java" target="code">DisicvtClient.java</a> 
</pre>

Invocando da un browser
<pre>
http://localhost:3000
</pre>
si ottiene solo un 'welcome' in quanto al momento non e' prevista aluna internazione <i>human-to-machine</i> a questo livello.


<!--
=================================================================================================
La logica della trasformazione
=================================================================================================
-->
<h2>La logica della trasformazione</h2>
Il processo di trasformazione definito da Microsoft (in <a href="../DisiFhirConverter/workers/uniboworker.js" target="code">uniboworker.js</a>)
consiste nel passare a un template di rferimento Handlebar opportunamente compilato i dati rappresentati dal messaggio HL7 opportunamente
racchiusi in un context object 
<div class="remark">
Si veda <a href="https://webapplog.com/handlebars/" target="web">Handlebars Tutorial</a> per la parte Node
e <a href="https://www.baeldung.com/handlebars" target="web">Templating with Handlebars</a> per la parte Java.
</div>
Il template di rferimento puo' fare uso di <em>helpers</em> built-in (e.g. <tt>{{#with ...}}</tt>,  <tt>each , if</tt>) o di helper
custom (<tt>{{#custonheleper ...}}{{/custonheleper}}</tt> ). 
<br/> 
Un helper custom accetta un context e oggetti options e deve essere <ks>registrato</ks> nella Handlebar instace in uso (si veda
<a href="#registrazione">registrazione</a>).
<br/><br/>
<!-- generateResult (in <a href="../DisiFhirConverter/workers/uniboworker.js" target="code">uniboworker.js</a>) -->

L'attuale processo di trasformazione si articola nelle seguenti fasi:<br/><br/>
<ol>
<li>
preparazione dei dati di lavoro all'interno di un oggetto <ks>workData</ks>:
<pre>
function <ks>convert( templateString, HL7Msg, <k>response</k> )</ks> {
	workData.srcDataType	= "hl7v2";
	workData.templateString = templateString;	<i>templateString letta da file</i>
	workData.msg            = HL7Msg;		<i>dato HL7 letto da file</i>
	<ks>doconvert(workData, <k>response</k> );</ks>
</pre>
Nella versione 'online', questa funzione viene invocata da  <a href="../routes/disicvt.js" target="code">routes/disicvt.js</a>.
</li>
<li>utilizzo di una <tt>handlebarInstance</tt> (creata dalla operazione <m><ks>GetHandlebarsInstance</ks></m>) 
per compilare <ks>workData.templateString</ks> ottenendo un <k>template</k> code:
<pre>
 function ret(context, execOptions) {
    if (!compiled) { compiled = compileInput(); }
    return compiled.call(this, context, execOptions);
  }
</pre></li>
<li>utilizzo di un oggetto <k>dataTypeHandler</k> (creato da una 
<a href="../DisiFhirConverter/dataHandler/dataHandlerFactory.js" target="code"><m><ks>dataHandlerFactory.js</ks></m></a>
 relativa a <tt>workData.srcDataType</tt>) per fare il parsing di <ks>workData.msg</ks> il cui risultato viene inserito in un oggetto <k>dataContext</k> 
 <pre>
dataContext.msg.v2.meta		<i>nomi dei segmenti del dato</i>
dataContext.msg.v2.data		<i>segmenti del dato</i>
</pre>
 </li>
<li>generazione di una trasformazione invocando <ks>generateResult( <k>dataTypeHandler</k>, <k>dataContext</k>, <k>template</k> )</ks></li>
<li>inserzione del risultato della trasformazione nell'oggetto <k>response</k> e restituire tale risultato al chiamante </li>
</ol>

<table style="width:98%">
<tbody>	
<tr>
<td style="width:50%" ><center> <img src="./img/DISIFhirHl7Converter.png" alt="DISIFhirHl7Converter.png" width="75%"> </center> 
</td>
<td><h4><a href="../DisiFhirConverter/dataHandler/dataHandlerFactory.js" target="code">dataHandlerFactory.js</a></h4>

La classe  <a href="../DisiFhirConverter/dataHandler/dataHandlerFactory.js" target="code">dataHandlerFactory.js</a> restituisce oggetti relativi alle categorie
HL7 e CDA. <br/>
Nel caso nostro (HL7), <a href="../DisiFhirConverter/dataHandler/dataHandlerFactory.js" target="code">dataHandlerFactory.js</a> 
restituisce un oggetto di tipo <a href="../DisiFhirConverter/hl7v2/hl7v2.js" target="code">hl7v2.js</a>
come  specializzazione della classe <a href="../DisiFhirConverter/dataHandler/dataHandler.js" target="code">dataHandler.js</a>.

<h4><a href="../DisiFhirConverter/hl7v2/hl7v2.js" target="code">hl7v2.js</a></h4>
 La casse <a href="../DisiFhirConverter/hl7v2/hl7v2.js" target="code">hl7v2.js</a>
e' una specializzazione di <a href="../DisiFhirConverter/dataHandler/dataHandler.js" target="code">dataHandler.js</a>
che funge da <k>dataTypeHandler</k> 

<h4><a href="../DisiFhirConverter/handlebars-converter/handlebars-converter.js" target="code">HandlebarsConverter.instance</a></h4>
Contiene il 'core' della conversione basata su Handlecare.

<h4>generateResult (in <a href="../DisiFhirConverter/workers/uniboworker.js" target="code">uniboworker.js</a>)</h4>
Invoca i template preparati e fornisce il risultato come String Json.
</td>
</tr>
 </tbody>
</table>
 <br/><br/>
<h3>dataTypeHandler</h3> 
<li> 
<k>dataTypeHandler</k> e' un oggetto di classe <a href="../DisiFhirConverter/hl7v2/hl7v2.js" target="code">hl7v2.js</a> che specializza
la classe <a href="../DisiFhirConverter/dataHandler/dataHandler.js" target="code">dataHandler.js</a>.
</li><li> 
Viene creato da <a href="../DisiFhirConverter/dataHandler/dataHandlerFactory.js" target="code">dataHandlerFactory.js</a>
relativa alla categoria <ks>workData.srcDataType</ks> (nel caso nostro <tt>hl7v2</tt>).
</li>
<li>fornisce operazioni quali:
<pre>
parseHL7v2( msg ) <kc>//msg: dato HL7 | restituisce un oggetto con i segeunti campi: </kc>
v2.meta		<i>contiene i nomi dei segmenti (MSH,EVN,PID,NK1,PV1,...) del dato </i>
v2.data 	<i>contiene i segmenti del dato </i>
</pre>
</li>

<h3 id="GetHandlebarsInstance">GetHandlebarsInstance</h3> 
<li>La operazione <ks>GetHandlebarsInstance(dataTypeHandler, templatesMap)</ks>
definita in <a href="../DisiFhirConverter/workers/uniboworker.js" target="code">uniboworker.js</a>, restituisce una 
<a href="../DisiFhirConverter/handlebars-converter/handlebars-converter.js" target="code"><ks>HandlebarsConverter.instance</ks> (in handlebars-converter.js)</a>
che include il <k>dataTypeHandler</k>.
</li>

<li>la istanza <a href="../DisiFhirConverter/handlebars-converter/handlebars-converter.js" target="code">handlebars-converter.js</a> 
gestisce il template  <k>hbs</k> di riferimento per la trasformazione memorizzando una istanza di <k>Handlebars</k> opportunamente configurata:
<pre>
  handlebarsInstances[dataType] = Handlebars.create();
  var origResolvePartial        = handlebarsInstances[dataType].VM.resolvePartial;
  handlebarsInstances[dataType].VM.resolvePartial = function (partial, context, options) { ... } <kc>//STORED-FUN</kc> 
</pre>
<li id="registrazione"><ks>registra</ks> i template  <ks>helper</ks> per le operazioni <tt>if,eq,ne,...multiply,divide</tt> definite in
<a href="../DisiFhirConverter/handlebars-converter/handlebars-helpers.js" target="code">handlebars-helpers.js</a> 
</li>

<li>la funzione <m><kc>STORED-FUN</kc></m>, <ks>registra</ks> i template di servizio <ks>partial</ks> inclusi
(<tt>{{>...}}</tt>) in quello principale.

<div class="remark">
<ks>Partials</ks>  are akin to helpers and are registered with <k>Handlebars.registerPartial(name, source)</k>, 
where <i>name</i> is a string and <i>source</i> is a Handlebars template code for the partial
(from <a href="https://webapplog.com/handlebars/" target="web">Handlebars Tutorial</a>).
</div>



 
<h3>generateResult</h3>
L'operazione <ks>generateResult( <k>dataTypeHandler,dataContext, template</k> )</ks> definita
in  <a href="../DisiFhirConverter/workers/uniboworker.js" target="code">uniboworker.js</a> :
<ol>
<li>Invoca <tt>template(dataContext)</tt> e ottiene un oggetto <k>resultcvt</k> con molti campi.<br/> 
In questa fase invoca l'operazione <tt>getFirstSegments</tt> di 
<a href="../DisiFhirConverter/handlebars-converter/handlebars-helpers.js" target="code">handlebars-helpers.js</a> 
e poi esegue la funzione  <kc>STORED-FUN</kc>  che viene chiamata molte volte, registrando i templates inclusi nella directory
<a href="../DisiFhirConverter/templates/hl7v2/Resources" target="code">templates/hl7v2/Resources</a>  e
<a href="../DisiFhirConverter/templates/hl7v2/DataType" target="code">templates/hl7v2/DataType</a>  in relazione a quanto
specificato nel template di riferimento

</li>
<li>Invoca  <a href="../DisiFhirConverter/hl7v2/hl7v2.js" target="code">hl7v2.js</a> <tt>.postProcessResult(resultcvt)</tt> 
e ottiene un oggetto <k>result</k> con campi <tt>resourceType,type,entry</tt>:
<pre>
result.resourceType	= Bundle
result.type		= transaction
result.entry.length	= 5		//entry keys = <i>fullUrl,resource,request</i>

result.entry[0].resource keys: <i><k>resourceType,id</k>,identifier,name,birthDate,address,telecom,communication</i>
result.entry[1].resource keys: <i><k>resourceType,id</k>,...</i>
</pre>
<li>L'operazione <tt>postProcessResult</tt> chiama 
 <a href="../DisiFhirConverter/hl7v2/hl7v2.js" target="code">hl7v2.js</a><tt>.getConversionResultMetadata</tt> e
 <a href="../DisiFhirConverter/hl7v2/hl7v2.js" target="code">hl7v2.js</a><tt>.parseCoverageReport</tt>
</li>

</li>
 
</ol>
 
 



<table style="width:98%">
<tbody>	
<tr>
<td style="width:50%" >
</td>
<td>
</td>
</tr>
 </tbody>
</table>
 <br/><br/>
</div>  

  <br/><br/>

<div style="background-color:rgba(86, 56, 253, 0.9); width:100%;text-align:center;font-size:small;color:white">
By AN Unibo-DISI  
</div> 

</body>
</html>


 